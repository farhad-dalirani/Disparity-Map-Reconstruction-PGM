# Depth/Stereo Map Reconstruction with Factor Graph and Loopy Belief Propagation Maximum A Priori Estimation

Disparity maps obtained from various algorithms, such as block matching in rectified images, often contain regions with inaccurate disparity estimations. In reality, the disparity/depth maps exhibit gradual changes on objects in the scene, with more pronounced changes typically occurring at the edges of objects.

This repository addresses the enhancement of disparity maps obtained from algorithms by leveraging prior knowledge about the nature of disparity maps. One effective approach to incorporate this constraint is by employing graphical probabilistic models (PGMs), such as Factor Graphs. The code provided in this repository creates a `Factor Graph`, structured similarly to the diagram below, for a given input disparity map.

Each pixel in the disparity map is represented as a random variable following a discrete distribution, with possible integer values ranging from 0 to the maximum disparity value. The variables are interconnected through four factors, corresponding to their 4-connected neighbors in a grid. These factors play a crucial role in maintaining smoothness among adjacent pixels.

The design of these factors is guided by our prior knowledge about the scene. Specifically, we anticipate significant disparity changes primarily at the object edges, whereas disparities within objects are expected to change more gradually. In addition to the four factors promoting smoothness, each variable is associated with a unary factor. The unary factor is designed to encourage the random variable's value to align with the corresponding value in the input disparity map. By incorporating this factor, the factor graph aims to establish consistency between the estimated disparities and the provided disparity map.

In the `factors_depth_reconstruction.py` file, a class is provided that creates the initial Factor Graph and performs `Maximum A Priori Estimation` for variables using `Loopy Belief Propagation Maximum A Posteriori`.

As shown in the following GIF, the quality of disparity maps after refinement has been greatly improved, and many artifacts have been removed.

The initial disparity map were generated by this repository:  [Siamese CNN for Block Matching in Stereo Images Depth Mapping](https://github.com/farhad-dalirani/Siamese-Net-Stereo-Depth). 

<p align="center">
  <img src="readme_img/factor-graph-disparity-reconstruction.png" alt="Model Architecture" width="700">
</p> 

<p align="center">
  <img src="readme_img/Disparity-enhanced.gif" alt="Graphical Probabilistic Models (PGMs) Architecture" width="900">
</p> 

Please see the `run.py` file for usage of this algorithm, it contains an example involving `FactorGraphDepthReconstruction` class and the `loopy_belief_propagation_maximum_a_posteriori` method.